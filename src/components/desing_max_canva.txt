<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>M.A.X. ‚Äî Copilote IA CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Palette premium et micro-animations */
    :root{
      --bg1:#0b1020; /* navy profond */
      --bg2:#151a33; /* bleu nuit */
      --pri:#7c9bff; /* indigo doux */
      --pri-2:#a2b6ff;
      --acc:#22d3ee; /* cyan */
      --ok:#34d399; /* vert */
      --warn:#fbbf24; /* ambre */
      --err:#f87171; /* rouge doux */
      --glass: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --muted: rgba(255,255,255,0.6);
    }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid var(--stroke);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
    }
    .btn {
      transition: transform .08s ease, opacity .2s ease, box-shadow .2s ease;
    }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .chip {
      background: linear-gradient(180deg, rgba(124,155,255,0.18), rgba(124,155,255,0.10));
      border: 1px solid rgba(124,155,255,0.35);
    }
    .fade-in { animation: fade .25s ease; }
    @keyframes fade { from {opacity:0; transform: translateY(4px);} to {opacity:1; transform: translateY(0);} }
    .scroll-smooth::-webkit-scrollbar{ height:8px; width:8px;}
    .scroll-smooth::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.15); border-radius:999px;}
    .grad-bg{
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(124,155,255,0.18), transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(34,211,238,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .tag { border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); }
    .pill { border: 1px solid rgba(255,255,255,0.20); background: rgba(255,255,255,0.08); }
    .shadow-focus { box-shadow: 0 0 0 3px rgba(124,155,255,0.35); }
  </style>
</head>
<body class="min-h-screen grad-bg text-white antialiased selection:bg-indigo-400/30 selection:text-white">

  <!-- App Wrapper -->
  <div class="max-w-[1400px] mx-auto p-4 md:p-6 lg:p-8">
    <!-- Top Bar -->
    <header class="glass rounded-2xl px-4 md:px-6 py-3 md:py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 md:gap-4">
        <div class="h-10 w-10 rounded-xl grid place-items-center bg-gradient-to-br from-indigo-400/80 to-cyan-300/80 text-slate-900 font-black">
          M
        </div>
        <div>
          <div class="flex items-center gap-2">
            <h1 class="text-lg md:text-xl font-semibold tracking-tight">M.A.X.</h1>
            <span class="pill text-xs px-2 py-0.5 rounded-full text-indigo-200">Copilote IA CRM</span>
          </div>
          <p class="text-xs md:text-sm text-white/60">Analyse. Propose. Ex√©cute. Connect√© √† EspoCRM + n8n.</p>
        </div>
      </div>

      <div class="flex-1 max-w-xl hidden md:flex items-center gap-2">
        <div class="relative flex-1">
          <input id="globalSearch" type="search" placeholder="Rechercher un lead, une t√¢che, un deal‚Ä¶"
            class="w-full glass rounded-xl py-2.5 pl-10 pr-3 text-sm outline-none focus:shadow-focus"
          />
          <svg class="w-5 h-5 absolute left-3 top-2.5 text-white/50" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="7"></circle><path d="M21 21l-4.3-4.3"></path>
          </svg>
        </div>
        <button id="quickNewBtn" class="btn glass rounded-xl px-3 py-2 text-sm hover:bg-white/10">+ Nouveau</button>
      </div>

      <div class="flex items-center gap-2">
        <button id="openHelp" class="btn glass rounded-xl px-3 py-2 text-sm hover:bg-white/10">Centre d‚Äôaide</button>
        <div class="h-9 w-9 rounded-xl grid place-items-center bg-white/10">üë©‚Äçüíº</div>
      </div>
    </header>

    <div class="grid grid-cols-12 gap-4 md:gap-6 mt-4 md:mt-6">
      <!-- Sidebar -->
      <aside class="glass rounded-2xl col-span-12 lg:col-span-3 p-4 md:p-5 space-y-6">
        <div>
          <p class="text-xs uppercase tracking-wider text-white/50 mb-3">Navigation</p>
          <nav class="grid gap-2">
            <button data-tab="chat" class="tab-btn btn flex items-center justify-between w-full glass rounded-xl px-3 py-2.5 hover:bg-white/10">
              <span class="flex items-center gap-2">
                üí¨ <span>Chat</span>
              </span>
              <span class="tag text-xs rounded-md px-2 py-0.5">IA</span>
            </button>
            <button data-tab="leads" class="tab-btn btn flex items-center justify-between w-full rounded-xl px-3 py-2.5 hover:bg-white/10">
              <span class="flex items-center gap-2">
                üß≤ <span>Leads</span>
              </span>
              <span id="leadCount" class="tag text-xs rounded-md px-2 py-0.5">0</span>
            </button>
            <button data-tab="tasks" class="tab-btn btn flex items-center justify-between w-full rounded-xl px-3 py-2.5 hover:bg-white/10">
              <span class="flex items-center gap-2">
                ‚úÖ <span>T√¢ches</span>
              </span>
              <span id="taskCount" class="tag text-xs rounded-md px-2 py-0.5">0</span>
            </button>
            <button data-tab="deals" class="tab-btn btn flex items-center justify-between w-full rounded-xl px-3 py-2.5 hover:bg-white/10">
              <span class="flex items-center gap-2">
                üíº <span>Deals</span>
              </span>
              <span id="dealCount" class="tag text-xs rounded-md px-2 py-0.5">0</span>
            </button>
          </nav>
        </div>

        <div>
          <p class="text-xs uppercase tracking-wider text-white/50 mb-3">Contextes</p>
          <div id="contextChips" class="flex flex-wrap gap-2">
            <!-- Dynamique -->
          </div>
        </div>

        <div class="space-y-3">
          <p class="text-xs uppercase tracking-wider text-white/50">Raccourcis</p>
          <div class="grid gap-2">
            <button id="suggestNextBest" class="btn rounded-xl px-3 py-2 glass hover:bg-white/10 text-left">
              ‚ú® Proposer la prochaine meilleure action
            </button>
            <button id="runWorkflow" class="btn rounded-xl px-3 py-2 glass hover:bg-white/10 text-left">
              ‚öôÔ∏è Lancer un sc√©nario n8n (d√©mo)
            </button>
            <a href="https://www.espocrm.com/documentation/" target="_blank" rel="noopener noreferrer"
               class="btn rounded-xl px-3 py-2 glass hover:bg-white/10 text-left">
              üìò Docs EspoCRM
            </a>
            <a href="https://docs.n8n.io/" target="_blank" rel="noopener noreferrer"
               class="btn rounded-xl px-3 py-2 glass hover:bg-white/10 text-left">
              üîó Docs n8n
            </a>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="col-span-12 lg:col-span-9 grid grid-cols-12 gap-4 md:gap-6">
        <!-- Chat Panel -->
        <section id="view-chat" class="col-span-12 grid grid-cols-12 gap-4 md:gap-6">
          <div class="glass rounded-2xl p-4 md:p-6 col-span-12 xl:col-span-7 flex flex-col h-[70vh]">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">Chat intelligent</h2>
              <div class="flex items-center gap-2">
                <span class="tag text-xs rounded-md px-2 py-0.5">Contexte CRM actif</span>
                <span class="tag text-xs rounded-md px-2 py-0.5 text-emerald-300">Pr√™t</span>
              </div>
            </div>

            <div id="chatArea" class="flex-1 overflow-y-auto scroll-smooth space-y-4 pr-1">
              <!-- Messages dynamiques -->
            </div>

            <!-- Quick Suggestions -->
            <div id="chatTips" class="mt-3 flex flex-wrap gap-2">
              <button class="chip rounded-full text-sm px-3 py-1.5 btn">R√©sume mes leads chauds</button>
              <button class="chip rounded-full text-sm px-3 py-1.5 btn">Planifie 3 relances</button>
              <button class="chip rounded-full text-sm px-3 py-1.5 btn">Analyse des pertes de deals</button>
              <button class="chip rounded-full text-sm px-3 py-1.5 btn">√âcris un email de suivi</button>
            </div>

            <!-- Input -->
            <form id="chatForm" class="mt-3 flex items-end gap-2" autocomplete="off">
              <div class="flex-1 relative">
                <textarea id="chatInput" rows="1" placeholder="Parlez √† M.A.X. ‚Äî demandez, analysez, d√©l√©guez‚Ä¶"
                  class="w-full glass rounded-2xl px-4 py-3 pr-10 text-sm outline-none resize-none leading-6 focus:shadow-focus"
                ></textarea>
                <button id="micBtn" type="button" class="absolute right-2.5 bottom-2.5 text-white/60 hover:text-white/90">üéôÔ∏è</button>
              </div>
              <button class="btn rounded-2xl px-4 py-3 bg-gradient-to-br from-indigo-400 to-cyan-300 text-slate-900 font-semibold hover:opacity-90">
                Envoyer
              </button>
            </form>
          </div>

          <!-- Context & Actions -->
          <div class="glass rounded-2xl p-4 md:p-6 col-span-12 xl:col-span-5 h-[70vh] flex flex-col">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold">Actions M.A.X.</h3>
              <button id="clearContext" class="btn text-sm pill px-3 py-1.5 rounded-lg hover:bg-white/15">R√©initialiser</button>
            </div>

            <div id="smartActions" class="space-y-3 overflow-y-auto scroll-smooth pr-1 flex-1">
              <!-- Actions contextuelles dynamiques -->
            </div>

            <div class="mt-3">
              <p class="text-xs text-white/60 mb-2">Ex√©cution</p>
              <div class="flex gap-2">
                <button id="simulateSendEmails" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">üì® Envoyer 5 emails</button>
                <button id="simulateCreateTasks" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">üóìÔ∏è Cr√©er des t√¢ches</button>
                <button id="simulateSyncEspo" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">üîÑ Sync EspoCRM</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Leads View -->
        <section id="view-leads" class="col-span-12 hidden">
          <div class="glass rounded-2xl p-4 md:p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
              <h2 class="text-lg font-semibold">Leads</h2>
              <div class="flex items-center gap-2">
                <input id="leadFilter" placeholder="Filtrer‚Ä¶" class="glass rounded-xl px-3 py-2 text-sm outline-none focus:shadow-focus" />
                <select id="leadStage" class="glass rounded-xl px-3 py-2 text-sm outline-none focus:shadow-focus">
                  <option value="">Tous les statuts</option>
                  <option>Nouvel</option>
                  <option>Contact√©</option>
                  <option>Qualifi√©</option>
                </select>
                <button id="addLead" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">+ Ajouter</button>
              </div>
            </div>

            <div class="overflow-x-auto scroll-smooth">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-white/60">
                    <th class="text-left font-medium py-2">Nom</th>
                    <th class="text-left font-medium py-2">Entreprise</th>
                    <th class="text-left font-medium py-2">Valeur</th>
                    <th class="text-left font-medium py-2">Statut</th>
                    <th class="text-left font-medium py-2">Prochaine action</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="leadRows" class="align-top">
                  <!-- Lignes dynamiques -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Tasks View -->
        <section id="view-tasks" class="col-span-12 hidden">
          <div class="glass rounded-2xl p-4 md:p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
              <h2 class="text-lg font-semibold">T√¢ches</h2>
              <div class="flex items-center gap-2">
                <select id="taskFilter" class="glass rounded-xl px-3 py-2 text-sm outline-none focus:shadow-focus">
                  <option value="">Toutes</option>
                  <option value="today">Aujourd‚Äôhui</option>
                  <option value="overdue">En retard</option>
                  <option value="done">Termin√©es</option>
                </select>
                <button id="addTask" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">+ Nouvelle t√¢che</button>
              </div>
            </div>

            <ul id="taskList" class="grid gap-2">
              <!-- T√¢ches dynamiques -->
            </ul>
          </div>
        </section>

        <!-- Deals View -->
        <section id="view-deals" class="col-span-12 hidden">
          <div class="glass rounded-2xl p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold">Deals</h2>
              <button id="addDeal" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">+ Nouveau deal</button>
            </div>
            <div class="grid md:grid-cols-3 gap-4">
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm uppercase tracking-wide text-white/60">Prospection</h3>
                  <span id="colProspectCount" class="tag text-xs rounded-md px-2 py-0.5">0</span>
                </div>
                <div id="colProspect" class="min-h-[200px] glass rounded-xl p-3 space-y-2">
                  <!-- Cards -->
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm uppercase tracking-wide text-white/60">N√©gociation</h3>
                  <span id="colNegCount" class="tag text-xs rounded-md px-2 py-0.5">0</span>
                </div>
                <div id="colNeg" class="min-h-[200px] glass rounded-xl p-3 space-y-2">
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm uppercase tracking-wide text-white/60">Gagn√©</h3>
                  <span id="colWonCount" class="tag text-xs rounded-md px-2 py-0.5">0</span>
                </div>
                <div id="colWon" class="min-h-[200px] glass rounded-xl p-3 space-y-2">
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <!-- Modal (D√©mo) -->
  <div id="modal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative max-w-lg mx-auto mt-24 glass rounded-2xl p-5">
      <div class="flex items-start justify-between gap-2">
        <div>
          <h3 id="modalTitle" class="text-lg font-semibold">Titre</h3>
          <p id="modalDesc" class="text-white/70 text-sm">Description</p>
        </div>
        <button id="modalClose" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">Fermer</button>
      </div>
      <form id="modalForm" class="mt-4 grid gap-3">
        <input id="modalInput1" placeholder="Nom" class="glass rounded-xl px-3 py-2 text-sm outline-none focus:shadow-focus" />
        <input id="modalInput2" placeholder="D√©tail" class="glass rounded-xl px-3 py-2 text-sm outline-none focus:shadow-focus" />
        <div class="flex justify-end gap-2">
          <button type="button" id="modalCancel" class="btn pill px-3 py-2 rounded-lg hover:bg-white/15">Annuler</button>
          <button class="btn rounded-xl px-4 py-2 bg-gradient-to-br from-indigo-400 to-cyan-300 text-slate-900 font-semibold hover:opacity-90">Valider</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Donn√©es d√©mo
    const state = {
      tab: 'chat',
      leads: [
        {id:'l1', name:'Alice Martin', company:'Lumina', value:12000, stage:'Contact√©', next:'Relance email'},
        {id:'l2', name:'Karim Lopez', company:'NovaTech', value:8000, stage:'Nouvel', next:'Appel d√©couverte'},
        {id:'l3', name:'Sophie Laurent', company:'GreenPulse', value:15000, stage:'Qualifi√©', next:'D√©mo produit'}
      ],
      tasks: [
        {id:'t1', title:'Relancer Alice', due:'2025-09-26', done:false},
        {id:'t2', title:'Pr√©parer d√©mo GreenPulse', due:'2025-09-27', done:false},
        {id:'t3', title:'Appel d√©couverte Karim', due:'2025-09-24', done:true}
      ],
      deals: [
        {id:'d1', name:'Lumina - Suite Pro', amount:24000, stage:'Prospect'},
        {id:'d2', name:'GreenPulse - Annual', amount:48000, stage:'Negotiation'},
        {id:'d3', name:'NovaTech - Starter', amount:12000, stage:'Won'}
      ],
      chat: [
        {role:'assistant', text:"Bonjour, je suis M.A.X. Votre copilote CRM. Je peux analyser vos leads, prioriser vos t√¢ches et ex√©cuter des actions (emails, relances, workflows n8n). Par quoi commence-t-on ?"},
      ],
      context: ['Leads chauds', 'Cycle 30 jours'],
    };

    // Utils
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function toast(msg, type='info'){
      const wrap = document.createElement('div');
      const color = type==='ok' ? 'from-emerald-400 to-teal-300' :
                    type==='warn' ? 'from-amber-400 to-yellow-300' :
                    type==='err' ? 'from-rose-400 to-red-300' : 'from-indigo-400 to-cyan-300';
      wrap.className = 'fade-in glass rounded-xl p-3 pl-3 pr-10 relative';
      wrap.innerHTML = `
        <div class="flex items-center gap-2">
          <span>${ type==='ok' ? '‚úÖ' : type==='warn' ? '‚ö†Ô∏è' : type==='err' ? '‚õî' : '‚ú®' }</span>
          <p class="text-sm">${msg}</p>
        </div>
        <button class="absolute right-2 top-2 pill px-2 py-1 rounded-md hover:bg-white/15 text-xs">Fermer</button>
        <div class="absolute bottom-0 left-0 h-1 bg-gradient-to-r ${color}" style="width:0%;" ></div>
      `;
      $('#toasts').appendChild(wrap);
      const bar = wrap.querySelector('div.absolute.bottom-0');
      let p=0;
      const int = setInterval(()=>{ p+=3; bar.style.width = p+'%'; if(p>=100){ clearInterval(int); wrap.remove(); } }, 60);
      wrap.querySelector('button').onclick = ()=>{ clearInterval(int); wrap.remove(); };
    }

    function formatEUR(n){ return new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(n); }

    // Tabs
    function setTab(tab){
      state.tab = tab;
      ['chat','leads','tasks','deals'].forEach(t=>{
        $('#view-'+t).classList.toggle('hidden', t!==tab);
      });
      $$('.tab-btn').forEach(b=>{
        const active = b.getAttribute('data-tab')===tab;
        b.classList.toggle('glass', true);
        b.classList.toggle('bg-white/10', active);
        b.classList.toggle('border', false);
      });
      if(tab==='leads') renderLeads();
      if(tab==='tasks') renderTasks();
      if(tab==='deals') renderDeals();
    }

    // Sidebar counts & context
    function renderCounts(){
      $('#leadCount').textContent = state.leads.length;
      $('#taskCount').textContent = state.tasks.length;
      $('#dealCount').textContent = state.deals.length;
    }
    function renderContext(){
      const box = $('#contextChips');
      box.innerHTML = '';
      state.context.forEach((c,i)=>{
        const el = document.createElement('button');
        el.className = 'chip rounded-full text-xs px-3 py-1.5 btn';
        el.textContent = c;
        el.onclick = ()=>{ state.context.splice(i,1); renderContext(); toast('Contexte retir√©','warn'); renderSmartActions(); };
        box.appendChild(el);
      });
    }

    // Chat
    function renderChat(){
      const area = $('#chatArea');
      area.innerHTML = '';
      state.chat.forEach(msg=>{
        const row = document.createElement('div');
        const isMe = msg.role==='user';
        row.className = 'flex ' + (isMe ? 'justify-end' : 'justify-start');
        const bubble = document.createElement('div');
        bubble.className = 'max-w-[80%] rounded-2xl px-4 py-3 fade-in ' + (isMe ? 'bg-white/90 text-slate-900' : 'glass');
        bubble.innerHTML = '<p class="text-sm leading-6">' + (msg.text) + '</p>';
        row.appendChild(bubble);
        area.appendChild(row);

        // Actions propos√©es attach√©es √† certaines r√©ponses
        if(msg.actions){
          const act = document.createElement('div');
          act.className = 'mt-2 grid gap-2 ' + (isMe ? 'justify-items-end' : 'justify-items-start');
          msg.actions.forEach(a=>{
            const btn = document.createElement('button');
            btn.className = 'btn pill px-3 py-2 rounded-lg hover:bg-white/15 text-sm';
            btn.textContent = a.label;
            btn.onclick = a.onClick;
            act.appendChild(btn);
          });
          area.appendChild(act);
        }
      });
      area.scrollTop = area.scrollHeight;
    }

    function addAssistant(text, actions){
      state.chat.push({role:'assistant', text, actions});
      renderChat();
    }
    function addUser(text){
      state.chat.push({role:'user', text});
      renderChat();
    }

    // Actions intelligentes (panneau droit)
    function renderSmartActions(){
      const box = $('#smartActions');
      box.innerHTML = '';
      const actions = [
        {icon:'üß†', title:'Prioriser les 3 leads √† contacter', desc:'Analyse de probabilit√© de conversion et derni√®re activit√©.',
          run: ()=> { setTab('leads'); toast('3 leads prioritaires mis en avant','ok'); }},
        {icon:'‚úâÔ∏è', title:'R√©diger un email de suivi', desc:'Proposition de message personnalis√© par segment.',
          run: ()=> { addAssistant("J‚Äôai pr√©par√© 3 emails de suivi adapt√©s. Voulez-vous les envoyer maintenant ?", [
            {label:'Aper√ßu emails', onClick:()=>toast('Aper√ßu (d√©mo)','info')},
            {label:'Envoyer 3 emails', onClick:()=>toast('Emails envoy√©s (d√©mo)','ok')}
          ]); }},
        {icon:'üóìÔ∏è', title:'Planifier 3 relances', desc:'Cr√©ation de t√¢ches sur 7/14/21 jours dans EspoCRM.',
          run: ()=> { createBulkTasks(); }},
        {icon:'‚öôÔ∏è', title:'D√©clencher un workflow n8n', desc:'Segmenter et synchroniser des contacts (d√©mo).',
          run: ()=> { toast('Workflow n8n d√©clench√© (d√©mo)','ok'); }},
      ];

      // Ajouter contexte en tags
      if(state.context.length){
        const ctx = document.createElement('div');
        ctx.className = 'mb-2 flex flex-wrap gap-2';
        state.context.forEach(c=>{
          const t = document.createElement('span');
          t.className = 'tag rounded-full text-xs px-2 py-1';
          t.textContent = c;
          ctx.appendChild(t);
        });
        box.appendChild(ctx);
      }

      actions.forEach(a=>{
        const card = document.createElement('div');
        card.className = 'glass rounded-xl p-3 hover:bg-white/05 transition';
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="text-lg">${a.icon}</div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <h4 class="font-medium">${a.title}</h4>
                <button class="btn rounded-lg px-3 py-1.5 bg-white/10 hover:bg-white/20 text-sm">Ex√©cuter</button>
              </div>
              <p class="text-sm text-white/70 mt-1">${a.desc}</p>
            </div>
          </div>
        `;
        card.querySelector('button').onclick = a.run;
        box.appendChild(card);
      });
    }

    // Leads
    function renderLeads(){
      $('#leadRows').innerHTML = '';
      const q = ($('#leadFilter').value||'').toLowerCase();
      const stage = $('#leadStage').value || '';
      state.leads
        .filter(l => (!q || (l.name+l.company).toLowerCase().includes(q)) && (!stage || l.stage===stage))
        .forEach(l=>{
          const tr = document.createElement('tr');
          tr.className = 'border-b border-white/10 hover:bg-white/5';
          tr.innerHTML = `
            <td class="py-3">
              <div class="flex items-center gap-2">
                <span class="h-7 w-7 rounded-full bg-white/10 grid place-items-center">üë§</span>
                <div>
                  <div class="font-medium">${l.name}</div>
                  <div class="text-xs text-white/60">#${l.id}</div>
                </div>
              </div>
            </td>
            <td class="py-3">${l.company}</td>
            <td class="py-3">${formatEUR(l.value)}</td>
            <td class="py-3">
              <span class="tag text-xs rounded-md px-2 py-1">${l.stage}</span>
            </td>
            <td class="py-3">${l.next || '-'}</td>
            <td class="py-3 text-right">
              <div class="flex justify-end gap-2">
                <button class="btn pill px-2.5 py-1.5 rounded-md hover:bg-white/15 text-xs">D√©tails</button>
                <button class="btn pill px-2.5 py-1.5 rounded-md hover:bg-white/15 text-xs">Relancer</button>
                <button class="btn pill px-2.5 py-1.5 rounded-md hover:bg-white/15 text-xs">Qualifier</button>
              </div>
            </td>
          `;
          const [btnDetails, btnRelance, btnQual] = tr.querySelectorAll('button');
          btnDetails.onclick = ()=> openLeadModal(l);
          btnRelance.onclick = ()=> { toast('Email de relance propos√© (d√©mo)','info'); addAssistant(`Je propose un email de relance pour ${l.name} chez ${l.company}. Voulez-vous l‚Äôenvoyer ?`, [
            {label:'Envoyer maintenant', onClick:()=>toast('Relance envoy√©e (d√©mo)','ok')},
            {label:'Personnaliser', onClick:()=>toast('Ouverture √©diteur (d√©mo)','info')},
          ]); setTab('chat'); };
          btnQual.onclick = ()=> { l.stage='Qualifi√©'; l.next='Proposer une d√©mo'; renderLeads(); renderCounts(); toast('Lead qualifi√©','ok'); };
          $('#leadRows').appendChild(tr);
        });
      renderCounts();
    }

    function openLeadModal(l){
      $('#modalTitle').textContent = 'Lead ‚Äî ' + l.name;
      $('#modalDesc').textContent = `${l.company} ‚Ä¢ Valeur ${formatEUR(l.value)} ‚Ä¢ ${l.stage}`;
      $('#modalInput1').value = l.name;
      $('#modalInput2').value = l.company;
      openModal((vals)=>{
        l.name = vals[0]; l.company = vals[1] || l.company;
        renderLeads(); toast('Lead mis √† jour','ok');
      });
    }

    // Tasks
    function renderTasks(){
      const q = $('#taskFilter').value || '';
      $('#taskList').innerHTML = '';
      const today = new Date().toISOString().slice(0,10);
      state.tasks
        .filter(t=>{
          if(q==='done') return t.done;
          if(q==='today') return t.due===today && !t.done;
          if(q==='overdue') return t.due < today && !t.done;
          return true;
        })
        .forEach(t=>{
          const li = document.createElement('li');
          li.className = 'glass rounded-xl p-3 flex items-center justify-between gap-3';
          li.innerHTML = `
            <div class="flex items-center gap-3">
              <input type="checkbox" ${t.done?'checked':''} class="h-5 w-5 rounded-md" />
              <div>
                <div class="font-medium ${t.done?'line-through text-white/60':''}">${t.title}</div>
                <div class="text-xs ${!t.done && t.due < today ? 'text-amber-300' : 'text-white/60'}">√âch√©ance: ${t.due}</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn pill px-2.5 py-1.5 rounded-md hover:bg-white/15 text-xs">D√©tails</button>
              <button class="btn pill px-2.5 py-1.5 rounded-md hover:bg-white/15 text-xs">Supprimer</button>
            </div>
          `;
          const [cb] = li.querySelectorAll('input');
          cb.onchange = ()=>{ t.done = cb.checked; renderTasks(); renderCounts(); };
          const [btnDet, btnDel] = li.querySelectorAll('button');
          btnDet.onclick = ()=>{ $('#modalTitle').textContent = 'T√¢che'; $('#modalDesc').textContent = 'Modifier la t√¢che'; $('#modalInput1').value=t.title; $('#modalInput2').value=t.due; openModal(vals=>{ t.title=vals[0]; t.due=vals[1]||t.due; renderTasks(); toast('T√¢che mise √† jour','ok'); }); };
          btnDel.onclick = ()=>{ state.tasks = state.tasks.filter(x=>x.id!==t.id); renderTasks(); renderCounts(); toast('T√¢che supprim√©e','warn'); };
          $('#taskList').appendChild(li);
        });
      renderCounts();
    }

    function createBulkTasks(){
      const items = [
        {id:'auto1', title:'Relance J+7', due: addDays(7), done:false},
        {id:'auto2', title:'Relance J+14', due: addDays(14), done:false},
        {id:'auto3', title:'Relance J+21', due: addDays(21), done:false},
      ];
      state.tasks = [...items, ...state.tasks];
      renderTasks();
      toast('3 t√¢ches planifi√©es','ok');
    }
    function addDays(n){
      const d = new Date(); d.setDate(d.getDate()+n);
      return d.toISOString().slice(0,10);
    }

    // Deals
    function renderDeals(){
      const cols = {Prospect: $('#colProspect'), Negotiation: $('#colNeg'), Won: $('#colWon')};
      Object.values(cols).forEach(c=> c.innerHTML='');
      const counts = {Prospect:0, Negotiation:0, Won:0};
      state.deals.forEach(d=>{
        const card = document.createElement('div');
        card.className = 'glass rounded-xl p-3';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-medium">${d.name}</div>
              <div class="text-xs text-white/60">${formatEUR(d.amount)}</div>
            </div>
            <select class="pill rounded-md px-2 py-1 text-xs">
              <option ${d.stage==='Prospect'?'selected':''}>Prospect</option>
              <option value="Negotiation" ${d.stage==='Negotiation'?'selected':''}>Negotiation</option>
              <option value="Won" ${d.stage==='Won'?'selected':''}>Won</option>
            </select>
          </div>
          <div class="mt-2 flex items-center justify-end gap-2">
            <button class="btn pill px-2.5 py-1.5 rounded-md hover:bg-white/15 text-xs">Note</button>
            <button class="btn pill px-2.5 py-1.5 rounded-md hover:bg-white/15 text-xs">Proposer √©tape suivante</button>
          </div>
        `;
        const sel = card.querySelector('select');
        sel.onchange = ()=> { d.stage = sel.value; renderDeals(); toast('√âtape mise √† jour','ok'); };
        const [btnNote, btnNext] = card.querySelectorAll('button');
        btnNote.onclick = ()=>{ $('#modalTitle').textContent='Ajouter une note'; $('#modalDesc').textContent=d.name; $('#modalInput1').value=''; $('#modalInput2').value=''; openModal(vals=>{ toast('Note ajout√©e (d√©mo)','ok'); }); };
        btnNext.onclick = ()=>{ addAssistant(`Pour "${d.name}", je recommande une d√©mo la semaine prochaine. Voulez-vous planifier ?`, [
          {label:'Planifier', onClick:()=>{ state.tasks.unshift({id:'t'+Math.random(), title:'Planifier d√©mo - '+d.name, due:addDays(5), done:false}); renderTasks(); toast('T√¢che cr√©√©e','ok'); }},
          {label:'Plus tard', onClick:()=>toast('Rappel report√©','warn')}
        ]); setTab('chat'); };
        cols[d.stage].appendChild(card);
        counts[d.stage]++;
      });
      $('#colProspectCount').textContent = counts['Prospect']||0;
      $('#colNegCount').textContent = counts['Negotiation']||0;
      $('#colWonCount').textContent = counts['Won']||0;
      renderCounts();
    }

    // Modal
    function openModal(onSubmit){
      const m = $('#modal');
      m.classList.remove('hidden');
      m.querySelector('#modalForm').onsubmit = (e)=>{ e.preventDefault(); onSubmit([$('#modalInput1').value, $('#modalInput2').value]); closeModal(); };
      $('#modalCancel').onclick = closeModal;
      $('#modalClose').onclick = closeModal;
    }
    function closeModal(){ $('#modal').classList.add('hidden'); }

    // Global search (d√©mo)
    $('#globalSearch').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q){ return; }
      // Retour rapide dans le chat
      setTab('chat');
      addAssistant(`J‚Äôai cherch√© ‚Äú${e.target.value}‚Äù. R√©sultats: ${state.leads.filter(l=>(l.name+l.company).toLowerCase().includes(q)).length} leads, ${state.tasks.filter(t=>t.title.toLowerCase().includes(q)).length} t√¢ches.`);
    });

    // Chat events
    $('#chatForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = $('#chatInput').value.trim();
      if(!text) return;
      $('#chatInput').value = '';
      addUser(text);
      // R√©ponse simul√©e
      setTimeout(()=>{
        const suggestions = [
          {label:'Cr√©er 2 t√¢ches', onClick:()=>{ state.tasks.unshift({id:'tx1', title:'Relance rapide', due:addDays(2), done:false}); state.tasks.unshift({id:'tx2', title:'Email de suivi', due:addDays(1), done:false}); renderTasks(); toast('T√¢ches cr√©√©es','ok'); }},
          {label:'Envoyer un email', onClick:()=>toast('Email envoy√© (d√©mo)','ok')},
          {label:'Voir les leads', onClick:()=>setTab('leads')}
        ];
        addAssistant("Compris. Voici ce que je propose:", suggestions);
        renderSmartActions();
      }, 600);
    });

    // Quick tips
    $('#chatTips').addEventListener('click', (e)=>{
      if(e.target.tagName==='BUTTON'){
        const v = e.target.textContent;
        $('#chatInput').value = v;
        $('#chatForm').dispatchEvent(new Event('submit'));
      }
    });

    // Smart execution buttons
    $('#simulateSendEmails').onclick = ()=> toast('5 emails envoy√©s (d√©mo)', 'ok');
    $('#simulateCreateTasks').onclick = ()=> createBulkTasks();
    $('#simulateSyncEspo').onclick = ()=> toast('Synchronisation EspoCRM effectu√©e (d√©mo)', 'ok');
    $('#clearContext').onclick = ()=>{ state.context=[]; renderContext(); renderSmartActions(); toast('Contexte r√©initialis√©','warn'); };

    // Shortcuts
    $('#suggestNextBest').onclick = ()=> {
      setTab('chat');
      addAssistant("Prochaine meilleure action: Relancer Alice (derni√®re activit√© J-5, forte valeur). Voulez-vous que je programme une relance demain ?", [
        {label:'Oui, programme', onClick:()=>{ state.tasks.unshift({id:'tNB', title:'Relance Alice', due:addDays(1), done:false}); renderTasks(); toast('Relance programm√©e','ok'); }},
        {label:'Voir d√©tails', onClick:()=>setTab('leads')}
      ]);
    };
    $('#runWorkflow').onclick = ()=> { toast('n8n d√©clench√© (d√©mo)', 'ok'); };

    // Leads controls
    $('#leadFilter').addEventListener('input', renderLeads);
    $('#leadStage').addEventListener('change', renderLeads);
    $('#addLead').onclick = ()=>{
      $('#modalTitle').textContent = 'Nouveau lead';
      $('#modalDesc').textContent = 'Ajoutez rapidement un lead';
      $('#modalInput1').value = ''; $('#modalInput2').value = '';
      openModal(vals=>{
        const l = {id:'l'+Math.floor(Math.random()*9999), name: vals[0]||'Lead sans nom', company: vals[1]||'‚Äî', value: 5000, stage:'Nouvel', next:'Appel d√©couverte'};
        state.leads.unshift(l); renderLeads(); toast('Lead ajout√©','ok');
      });
    };

    // Tasks controls
    $('#taskFilter').addEventListener('change', renderTasks);
    $('#addTask').onclick = ()=>{
      $('#modalTitle').textContent = 'Nouvelle t√¢che';
      $('#modalDesc').textContent = 'D√©finissez un titre et une date';
      $('#modalInput1').value = ''; $('#modalInput2').value = addDays(3);
      openModal(vals=>{
        state.tasks.unshift({id:'t'+Math.random(), title: vals[0]||'T√¢che', due: vals[1]||addDays(3), done:false});
        renderTasks(); toast('T√¢che cr√©√©e','ok');
      });
    };

    // Deals controls
    $('#addDeal').onclick = ()=>{
      $('#modalTitle').textContent = 'Nouveau deal';
      $('#modalDesc').textContent = 'Renseignez le nom et le montant (dans D√©tail)';
      $('#modalInput1').value = ''; $('#modalInput2').value = '12000';
      openModal(vals=>{
        state.deals.unshift({id:'d'+Math.random(), name: vals[0]||'Deal', amount: parseFloat(vals[1]||'12000')||12000, stage:'Prospect'});
        renderDeals(); toast('Deal cr√©√©','ok');
      });
    };

    // Quick New
    $('#quickNewBtn').onclick = ()=> {
      const options = ['Lead','T√¢che','Deal'];
      const pick = options[Math.floor(Math.random()*options.length)];
      toast(`Raccourci ‚ÄúNouveau ${pick}‚Äù (ouvrez le bon onglet)`, 'info');
      if(pick==='Lead') setTab('leads');
      if(pick==='T√¢che') setTab('tasks');
      if(pick==='Deal') setTab('deals');
    };

    // Help modal
    $('#openHelp').onclick = ()=>{
      $('#modalTitle').textContent = 'Centre d‚Äôaide';
      $('#modalDesc').textContent = 'M.A.X. fonctionne en lecture/√©criture sur votre CRM via des actions guid√©es. Les int√©grations r√©elles se font c√¥t√© serveur (d√©mo ici).';
      $('#modalInput1').value = 'Astuce: utilisez le chat pour tout lancer.';
      $('#modalInput2').value = 'Les boutons Ex√©cuter simulent EspoCRM/n8n.';
      openModal(()=>{ closeModal(); });
    };

    // Sidebar tabs wiring
    $$('.tab-btn').forEach(btn=> btn.onclick = ()=> setTab(btn.getAttribute('data-tab')) );

    // Init
    function init(){
      renderCounts();
      renderContext();
      renderChat();
      renderSmartActions();
      setTab('chat');
      // Astuce initiale
      setTimeout(()=> toast('Astuce: dites ‚ÄúPlanifie 3 relances‚Äù pour cr√©er des t√¢ches automatiquement.'), 800);
    }
    init();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'983a531b744cd131',t:'MTc1ODYzMzQ3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
